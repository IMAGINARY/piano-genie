{"version":3,"sources":["node_modules/browser-pack/_prelude.js","js/main.js","js/piano-genie.js"],"names":["r","e","n","t","o","i","f","c","require","u","a","Error","code","p","exports","call","length","1","module","_pianoGenie","_main","defaultConfig","defaultLanguage","loadConfig","_callee2","uri","response","regeneratorRuntime","wrap","_context2","prev","next","fetch","sent","status","json","abrupt","t0","concat","message","statusText","stop","_asyncToGenerator","mark","_callee","config","_context","Object","t1","t2","t3","assign","IMAGINARY","i18n","init","queryStringVariable","translationsDirectory","initPianoGenie","document","querySelectorAll","forEach","element","innerHTML","getAttribute","t4","console","error","apply","this","arguments","keyWhitelist","CONSTANTS","COLORS","NUM_BUTTONS","NOTES_PER_OCTAVE","WHITE_NOTES_PER_OCTAVE","LOWEST_PIANO_KEY_MIDI_NOTE","NUM_NOTES","GENIE_CHECKPOINT","Player","_classCallCheck","player","mm","SoundFontPlayer","midiOut","midiIn","usingMidiOut","usingMidiIn","selectOutElement","getElementById","selectInElement","loadAllSamples","_createClass","key","value","seq","notes","push","pitch","loadSamples","button","sendMidiNoteOn","tone","context","resume","playNoteDown","sendMidiNoteOff","playNoteUp","midi","_this","addEventListener","event","initDevices","target","_this2","outputs","values","output","done","inputs","input","onmidimessage","msg","getMIDIMessage","map","device","name","join","selectedIndex","send","command","data","buttonDown","buttonUp","FloatyNotes","canvas","getContext","lineWidth","lineCap","contextHeight","whiteNoteHeight","width","window","innerWidth","height","innerHeight","x","noteToPaint","parseFloat","y","color","on","_this3","clearRect","filter","note","globalAlpha","fillStyle","fillRect","requestAnimationFrame","drawLoop","Piano","whiteNoteWidth","blackNoteWidth","blackNoteHeight","svg","svgNS","totalWhiteNotes","ratio","OCTAVES","Math","floor","setAttribute","halfABlackNote","index","blackNoteIndexes","makeRect","indexOf","_o","_i","rect","querySelector","log","removeAttribute","w","h","fill","stroke","createElementNS","appendChild","MAPPING_8","0","2","3","4","5","6","7","MAPPING_4","KEYCODES_NUMBERS","KEYCODES_STD","KEYCODES_MAKEY","BUTTON_MAPPING","TEMPERATURE","getTemperature","heldButtonToVisualData","Map","sustaining","sustainingNotes","mouseDownButton","genie","PianoGenie","painter","piano","isUsingMakey","updateNumButtons","num","buttons","hidden","doTouchStart","preventDefault","dataset","id","doTouchEnd","doTouchMove","down","el","has","nextFromKeyWhitelist","highlightNote","addNote","set","thing","get","clearNote","stopNote","onKeyDown","repeat","resetState","getButtonFromKeyCode","onKeyUp","onWindowResize","bonusNotes","totalNotes","Array","resize","draw","hash","params","location","substring","split","hk","temp","newTemp","min","updateButtonText","btns","display","initialize","then","controls","passive","radioMidiOutYes","midiOutBox","radioAudioYes","radioMidiInYes","midiInBox","radioDeviceYes","radioMakeyYes","navigator","requestMIDIAccess","midiNotSupported","parentElement","midiReady","err","showMainScreen","checked","infoBox","settingsBox","body","requestFullscreen","fullscreenElement","exitFullscreen","alert","style"],"mappings":"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","file":"bundle.min.js","sourcesContent":["(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c=\"function\"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error(\"Cannot find module '\"+i+\"'\");throw a.code=\"MODULE_NOT_FOUND\",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u=\"function\"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()","/* globals IMAGINARY */\nimport { initPianoGenie } from './piano-genie';\n\nconst defaultConfig = {\n  defaultLanguage: 'en',\n};\n\n/**\n * Loads the config file from an external JSON file\n *\n * @param {String} uri\n * @return {Promise<any>}\n */\nasync function loadConfig(uri) {\n  const response = await fetch(uri);\n  if (response.status >= 200 && response.status < 300) {\n    try {\n      return await response.json();\n    } catch (e) {\n      throw new Error(`Error parsing config file: ${e.message}`);\n    }\n  }\n  throw new Error(`Server returned status ${response.status} (${response.statusText}) loading config file.`);\n}\n\n/**\n * Load config files and start the program\n */\n(async function main() {\n  try {\n    const config = Object.assign({}, defaultConfig, await loadConfig('./config.json'));\n    await IMAGINARY.i18n.init({\n      queryStringVariable: 'lang',\n      translationsDirectory: 'tr',\n      defaultLanguage: config.defaultLanguage || 'en',\n    });\n    initPianoGenie();\n\n    document.querySelectorAll('[data-i18n-field]').forEach((element) => {\n      element.innerHTML = IMAGINARY.i18n.t(element.getAttribute('data-i18n-field'));\n    });\n  } catch (err) {\n    // eslint-disable-next-line no-console\n    console.error(err);\n  }\n}());\n","/* globals IMAGINARY */\n\nexport function initPianoGenie() {\n\n  const CONSTANTS = {\n    COLORS : ['#db4c67','#ff8459','#ffec02','#73ff6c',\n      '#00c5ba','#3753be','#9c52ff','#ef71f2'],\n    NUM_BUTTONS : 8,\n    NOTES_PER_OCTAVE : 12,\n    WHITE_NOTES_PER_OCTAVE : 7,\n    LOWEST_PIANO_KEY_MIDI_NOTE : 21,\n    NUM_NOTES: 88,\n    GENIE_CHECKPOINT : 'model/genie',\n  }\n\n  /*************************\n   * MIDI or Magenta player\n   ************************/\n  class Player {\n    constructor() {\n      this.player = new mm.SoundFontPlayer('vendor/sgm_plus');\n      this.midiOut = [];\n      this.midiIn = []\n      this.usingMidiOut = false;\n      this.usingMidiIn = false;\n      this.selectOutElement = document.getElementById('selectOut');\n      this.selectInElement = document.getElementById('selectIn');\n      this.loadAllSamples();\n    }\n\n    loadAllSamples() {\n      const seq = {notes:[]};\n      for (let i = 0; i < CONSTANTS.NUM_NOTES; i++) {\n        seq.notes.push({pitch: CONSTANTS.LOWEST_PIANO_KEY_MIDI_NOTE + i});\n      }\n      this.player.loadSamples(seq);\n    }\n\n    playNoteDown(pitch, button) {\n      // Send to MIDI out or play with the Magenta player.\n      if (this.usingMidiOut) {\n        this.sendMidiNoteOn(pitch, button);\n      } else {\n        mm.Player.tone.context.resume();\n        this.player.playNoteDown({pitch:pitch});\n      }\n    }\n\n    playNoteUp(pitch, button) {\n      // Send to MIDI out or play with the Magenta player.\n      if (this.usingMidiOut) {\n        this.sendMidiNoteOff(pitch, button);\n      } else {\n        this.player.playNoteUp({pitch:pitch});\n      }\n    }\n\n    // MIDI bits.\n    midiReady(midi) {\n      // Also react to device changes.\n      midi.addEventListener('statechange', (event) => this.initDevices(event.target));\n      this.initDevices(midi);\n    }\n\n    initDevices(midi) {\n      this.midiOut = [];\n      this.midiIn = [];\n\n\n      const outputs = midi.outputs.values();\n      for (let output = outputs.next(); output && !output.done; output = outputs.next()) {\n        this.midiOut.push(output.value);\n      }\n\n      const inputs = midi.inputs.values();\n      for (let input = inputs.next(); input && !input.done; input = inputs.next()) {\n        this.midiIn.push(input.value);\n        // TODO: should probably use the selected index from this.selectInElement for correctness\n        // but i'm hacking this together for a demo so...\n        input.value.onmidimessage = (msg) => this.getMIDIMessage(msg);\n\n      }\n\n      // No MIDI, no settings.\n      //btnSettings.hidden = (this.midiOut.length === 0 && this.midiIn.length === 0);\n      this.selectInElement.innerHTML = this.midiIn.map(device => `<option>${device.name}</option>`).join('');\n      this.selectOutElement.innerHTML = this.midiOut.map(device => `<option>${device.name}</option>`).join('');\n    }\n\n    sendMidiNoteOn(pitch, button) {\n      // -1 is sent when releasing the sustain pedal.\n      if (button === -1) button = 0;\n      //const msg = [0x90 + button, pitch, 0x7f];    // note on, full velocity.\n      const msg = [0x90, pitch, 0x7f];    // note on, full velocity.\n      this.midiOut[this.selectOutElement.selectedIndex].send(msg);\n    }\n\n    sendMidiNoteOff(pitch, button) {\n      // -1 is sent when releasing the sustain pedal.\n      if (button === -1) button = 0;\n      //const msg = [0x80 + button, pitch, 0x7f];    // note on, middle C, full velocity.\n      const msg = [0x80, pitch, 0x7f];    // note on, middle C, full velocity.\n      this.midiOut[this.selectOutElement.selectedIndex].send(msg);\n    }\n\n    getMIDIMessage(msg) {\n      if (!this.usingMidiIn) {\n        return;\n      }\n      const command = msg.data[0];\n      const button = msg.data[1];\n      const velocity = (msg.data.length > 2) ? msg.data[2] : 0; // a velocity value might not be included with a noteOff command\n\n      switch (command) {\n        case 0x90: // note on\n          buttonDown(button, false);\n          break;\n        case 0x80: // note off\n          buttonUp(button);\n          break;\n      }\n    }\n  }\n\n  /*************************\n   * Floaty notes\n   ************************/\n  class FloatyNotes {\n    constructor() {\n      this.notes = [];  // the notes floating on the screen.\n\n      this.canvas = document.getElementById('canvas')\n      this.context = this.canvas.getContext('2d');\n      this.context.lineWidth = 4;\n      this.context.lineCap = 'round';\n\n      this.contextHeight = 0;\n    }\n\n    resize(whiteNoteHeight) {\n      this.canvas.width = window.innerWidth;\n      this.canvas.height = this.contextHeight = window.innerHeight - whiteNoteHeight - 20;\n    }\n\n    addNote(button, x, width) {\n      const noteToPaint = {\n        x: parseFloat(x),\n        y: 0,\n        width: parseFloat(width),\n        height: 0,\n        color: CONSTANTS.COLORS[button],\n        on: true\n      };\n      this.notes.push(noteToPaint);\n      return noteToPaint;\n    }\n\n    stopNote(noteToPaint) {\n      noteToPaint.on = false;\n    }\n\n    drawLoop() {\n      const dy = 3;\n      this.context.clearRect(0, 0, window.innerWidth, window.innerHeight);\n\n      // Remove all the notes that will be off the page;\n      this.notes = this.notes.filter((note) => note.on || note.y < (this.contextHeight - 100));\n\n      // Advance all the notes.\n      for (let i = 0; i < this.notes.length; i++) {\n        const note = this.notes[i];\n\n        // If the note is still on, then its height goes up but it\n        // doesn't start sliding down yet.\n        if (note.on) {\n          note.height += dy;\n        } else {\n          note.y += dy;\n        }\n\n        this.context.globalAlpha = 1 - note.y / this.contextHeight;\n        this.context.fillStyle = note.color;\n        this.context.fillRect(note.x, note.y, note.width, note.height);\n      }\n      window.requestAnimationFrame(() => this.drawLoop());\n    }\n  }\n\n  class Piano {\n    constructor() {\n      this.config = {\n        whiteNoteWidth: 20,\n        blackNoteWidth: 20,\n        whiteNoteHeight: 70,\n        blackNoteHeight: 2 * 70 / 3\n      }\n\n      this.svg = document.getElementById('svg');\n      this.svgNS = 'http://www.w3.org/2000/svg';\n    }\n\n    resize(totalWhiteNotes) {\n      // i honestly don't know why some flooring is good and some is bad sigh.\n      const ratio = window.innerWidth / totalWhiteNotes;\n      this.config.whiteNoteWidth = OCTAVES > 6 ? ratio: Math.floor(ratio);\n      this.config.blackNoteWidth = this.config.whiteNoteWidth * 2 / 3;\n      this.svg.setAttribute('width', window.innerWidth);\n      this.svg.setAttribute('height', this.config.whiteNoteHeight);\n    }\n\n    draw() {\n      this.svg.innerHTML = '';\n      const halfABlackNote = this.config.blackNoteWidth / 2;\n      let x = 0;\n      let y = 0;\n      let index = 0;\n\n      const blackNoteIndexes = [1, 3, 6, 8, 10];\n\n      // First draw all the white notes.\n      // Pianos start on an A (if we're using all the octaves);\n      if (OCTAVES > 6) {\n        this.makeRect(0, x, y, this.config.whiteNoteWidth, this.config.whiteNoteHeight, 'white', '#141E30');\n        this.makeRect(2, this.config.whiteNoteWidth, y, this.config.whiteNoteWidth, this.config.whiteNoteHeight, 'white', '#141E30');\n        index = 3;\n        x = 2 * this.config.whiteNoteWidth;\n      } else {\n        // Starting 3 semitones up on small screens (on a C), and a whole octave up.\n        index = 3 + CONSTANTS.NOTES_PER_OCTAVE;\n      }\n\n      // Draw the white notes.\n      for (let o = 0; o < OCTAVES; o++) {\n        for (let i = 0; i < CONSTANTS.NOTES_PER_OCTAVE; i++) {\n          if (blackNoteIndexes.indexOf(i) === -1) {\n            this.makeRect(index, x, y, this.config.whiteNoteWidth, this.config.whiteNoteHeight, 'white', '#141E30');\n            x += this.config.whiteNoteWidth;\n          }\n          index++;\n        }\n      }\n\n      if (OCTAVES > 6) {\n        // And an extra C at the end (if we're using all the octaves);\n        this.makeRect(index, x, y, this.config.whiteNoteWidth, this.config.whiteNoteHeight, 'white', '#141E30');\n\n        // Now draw all the black notes, so that they sit on top.\n        // Pianos start on an A:\n        this.makeRect(1, this.config.whiteNoteWidth - halfABlackNote, y, this.config.blackNoteWidth, this.config.blackNoteHeight, 'black');\n        index = 3;\n        x = this.config.whiteNoteWidth;\n      } else {\n        // Starting 3 semitones up on small screens (on a C), and a whole octave up.\n        index = 3 + CONSTANTS.NOTES_PER_OCTAVE;\n        x = -this.config.whiteNoteWidth;\n      }\n\n      // Draw the black notes.\n      for (let o = 0; o < OCTAVES; o++) {\n        for (let i = 0; i < CONSTANTS.NOTES_PER_OCTAVE; i++) {\n          if (blackNoteIndexes.indexOf(i) !== -1) {\n            this.makeRect(index, x + this.config.whiteNoteWidth - halfABlackNote, y, this.config.blackNoteWidth, this.config.blackNoteHeight, 'black');\n          } else {\n            x += this.config.whiteNoteWidth;\n          }\n          index++;\n        }\n      }\n    }\n\n    highlightNote(note, button) {\n      // Show the note on the piano roll.\n      const rect = this.svg.querySelector(`rect[data-index=\"${note}\"]`);\n      if (!rect) {\n        console.log('couldnt find a rect for note', note);\n        return;\n      }\n      rect.setAttribute('active', true);\n      rect.setAttribute('class', `color-${button}`);\n      return rect;\n    }\n\n    clearNote(rect) {\n      rect.removeAttribute('active');\n      rect.removeAttribute('class');\n    }\n\n    makeRect(index, x, y, w, h, fill, stroke) {\n      const rect = document.createElementNS(this.svgNS, 'rect');\n      rect.setAttribute('data-index', index);\n      rect.setAttribute('x', x);\n      rect.setAttribute('y', y);\n      rect.setAttribute('width', w);\n      rect.setAttribute('height', h);\n      rect.setAttribute('fill', fill);\n      if (stroke) {\n        rect.setAttribute('stroke', stroke);\n        rect.setAttribute('stroke-width', '3px');\n      }\n      this.svg.appendChild(rect);\n      return rect;\n    }\n  }\n\n  /*************************\n   * Consts for everyone!\n   ************************/\n// button mappings.\n  const MAPPING_8 = {0:0, 1:1, 2:2, 3:3, 4:4, 5:5, 6:6, 7:7};\n  const MAPPING_4 = {0:0, 1:2, 2:5, 3:7, 4:0, 5:2, 6:5, 7:7};\n  const KEYCODES_NUMBERS = ['Digit1', 'Digit2', 'Digit3', 'Digit4', 'Digit5', 'Digit6', 'Digit7', 'Digit8'];\n  const KEYCODES_STD = ['KeyA', 'KeyS', 'KeyD', 'KeyF', 'KeyJ', 'KeyK', 'KeyL', 'Semicolon'];\n  const KEYCODES_MAKEY = ['ArrowUp','ArrowLeft','ArrowDown','ArrowRight', 'KeyW', 'KeyA', 'KeyS', 'KeyD'];\n\n  let OCTAVES = 7;\n  let NUM_BUTTONS = 8;\n  let BUTTON_MAPPING = MAPPING_8;\n\n  let keyWhitelist;\n  let TEMPERATURE = getTemperature();\n\n  const heldButtonToVisualData = new Map();\n\n// Which notes the pedal is sustaining.\n  let sustaining = false\n  let sustainingNotes = [];\n\n// Mousedown/up events are weird because you can mouse down in one element and mouse up\n// in another, so you're going to lose that original element and never mouse it up.\n  let mouseDownButton = null;\n\n  const player = new Player();\n  const genie = new mm.PianoGenie(CONSTANTS.GENIE_CHECKPOINT);\n  const painter = new FloatyNotes();\n  const piano = new Piano();\n  let isUsingMakey = false;\n  initEverything();\n\n  /*************************\n   * Basic UI bits\n   ************************/\n  function initEverything() {\n    genie.initialize().then(() => {\n      console.log('🧞‍♀️ ready!');\n      // playBtn.textContent = 'Play';\n      // playBtn.removeAttribute('disabled');\n      // playBtn.classList.remove('loading');\n      showMainScreen();\n    });\n\n    // Start the drawing loop.\n    onWindowResize();\n    updateButtonText();\n    window.requestAnimationFrame(() => painter.drawLoop());\n\n    // Event listeners.\n    document.getElementById('numButtons4').addEventListener('change', (event) => event.target.checked && updateNumButtons(4));\n    document.getElementById('numButtons8').addEventListener('change', (event) => event.target.checked && updateNumButtons(8));\n\n    window.addEventListener('resize', onWindowResize);\n    window.addEventListener('orientationchange', onWindowResize);\n    window.addEventListener('hashchange', () => TEMPERATURE = getTemperature());\n  }\n\n  function updateNumButtons(num) {\n    NUM_BUTTONS = num;\n    const buttons = document.querySelectorAll('.controls > .keyboard > button.color');\n    BUTTON_MAPPING = (num === 4) ? MAPPING_4 : MAPPING_8;\n\n    // Hide the extra buttons.\n    for (let i = 0; i < buttons.length; i++) {\n      buttons[i].hidden = i >= num;\n    }\n  }\n\n  function showMainScreen() {\n    document.querySelector('.splash').hidden = true;\n    document.querySelector('.loaded').hidden = false;\n\n    document.addEventListener('keydown',onKeyDown);\n\n    controls.addEventListener('touchstart', (event) => doTouchStart(event), {passive: true});\n    controls.addEventListener('touchend', (event) => doTouchEnd(event), {passive: true});\n\n    const hasTouchEvents = ('ontouchstart' in window);\n    if (!hasTouchEvents) {\n      controls.addEventListener('mousedown', (event) => doTouchStart(event));\n      controls.addEventListener('mouseup', (event) => doTouchEnd(event));\n    }\n\n    controls.addEventListener('mouseover', (event) => doTouchMove(event, true));\n    controls.addEventListener('mouseout', (event) => doTouchMove(event, false));\n    controls.addEventListener('touchenter', (event) => doTouchMove(event, true));\n    controls.addEventListener('touchleave', (event) => doTouchMove(event, false));\n    canvas.addEventListener('mouseenter', () => mouseDownButton = null);\n\n    // Output.\n    radioMidiOutYes.addEventListener('click', () => {\n      player.usingMidiOut = true;\n      midiOutBox.hidden = false;\n    });\n    radioAudioYes.addEventListener('click', () => {\n      player.usingMidiOut = false;\n      midiOutBox.hidden = true;\n    });\n    // Input.\n    radioMidiInYes.addEventListener('click', () => {\n      player.usingMidiIn = true;\n      midiInBox.hidden = false;\n      isUsingMakey = false;\n      updateButtonText();\n    });\n    radioDeviceYes.addEventListener('click', () => {\n      player.usingMidiIn = false;\n      midiInBox.hidden = true;\n      isUsingMakey = false;\n      updateButtonText();\n    });\n    radioMakeyYes.addEventListener('click', () => {\n      player.usingMidiIn = false;\n      midiInBox.hidden = true;\n      isUsingMakey = true;\n      updateButtonText();\n    });\n\n    // Figure out if WebMidi works.\n    if (navigator.requestMIDIAccess) {\n      midiNotSupported.hidden = true;\n      radioMidiInYes.parentElement.removeAttribute('disabled');\n      radioMidiOutYes.parentElement.removeAttribute('disabled');\n      navigator.requestMIDIAccess()\n        .then(\n          (midi) => player.midiReady(midi),\n          (err) => console.log('Something went wrong', err));\n    } else {\n      midiNotSupported.hidden = false;\n      radioMidiInYes.parentElement.setAttribute('disabled', true);\n      radioMidiOutYes.parentElement.setAttribute('disabled', true);\n    }\n\n    document.addEventListener('keyup', onKeyUp);\n\n    // Slow to start up, so do a fake prediction to warm up the model.\n    const note = genie.nextFromKeyWhitelist(0, keyWhitelist, TEMPERATURE);\n    genie.resetState();\n  }\n\n// Here touch means either touch or mouse.\n  function doTouchStart(event) {\n    event.preventDefault();\n    mouseDownButton = event.target;\n    buttonDown(event.target.dataset.id, true);\n  }\n  function doTouchEnd(event) {\n    event.preventDefault();\n    if (mouseDownButton && mouseDownButton !== event.target) {\n      buttonUp(mouseDownButton.dataset.id);\n    }\n    mouseDownButton = null;\n    buttonUp(event.target.dataset.id);\n  }\n  function doTouchMove(event, down) {\n    // If we're already holding a button down, start holding this one too.\n    if (!mouseDownButton)\n      return;\n\n    if (down)\n      buttonDown(event.target.dataset.id, true);\n    else\n      buttonUp(event.target.dataset.id, true);\n  }\n\n  /*************************\n   * Button actions\n   ************************/\n  function buttonDown(button, fromKeyDown) {\n    // If we're already holding this button down, nothing new to do.\n    if (heldButtonToVisualData.has(button)) {\n      return;\n    }\n\n    const el = document.getElementById(`btn${button}`);\n    if (!el)\n      return;\n    el.setAttribute('active', true);\n\n    const note = genie.nextFromKeyWhitelist(BUTTON_MAPPING[button], keyWhitelist, TEMPERATURE);\n    const pitch = CONSTANTS.LOWEST_PIANO_KEY_MIDI_NOTE + note;\n\n    // Hear it.\n    player.playNoteDown(pitch, button);\n\n    // See it.\n    const rect = piano.highlightNote(note, button);\n\n    if (!rect) {\n      debugger;\n    }\n    // Float it.\n    const noteToPaint = painter.addNote(button, rect.getAttribute('x'), rect.getAttribute('width'));\n    heldButtonToVisualData.set(button, {rect:rect, note:note, noteToPaint:noteToPaint});\n  }\n\n  function buttonUp(button) {\n    const el = document.getElementById(`btn${button}`);\n    if (!el)\n      return;\n    el.removeAttribute('active');\n\n    const thing = heldButtonToVisualData.get(button);\n    if (thing) {\n      // Don't see it.\n      piano.clearNote(thing.rect);\n\n      // Stop holding it down.\n      painter.stopNote(thing.noteToPaint);\n\n      // Maybe stop hearing it.\n      const pitch = CONSTANTS.LOWEST_PIANO_KEY_MIDI_NOTE + thing.note;\n      if (!sustaining) {\n        player.playNoteUp(pitch, button);\n      } else {\n        sustainingNotes.push(CONSTANTS.LOWEST_PIANO_KEY_MIDI_NOTE + thing.note);\n      }\n    }\n    heldButtonToVisualData.delete(button);\n  }\n\n  /*************************\n   * Events\n   ************************/\n  function onKeyDown(event) {\n    // Keydown fires continuously and we don't want that.\n    if (event.repeat) {\n      return;\n    }\n    if (event.key === ' ') {  // sustain pedal\n      sustaining = true;\n    } else if (event.key === '0' || event.key === 'r') {\n      console.log('🧞‍♀️ resetting!');\n      genie.resetState();\n    } else {\n      const button = getButtonFromKeyCode(event.code);\n      if (button != null) {\n        buttonDown(button, true);\n      }\n    }\n  }\n\n  function onKeyUp(event) {\n    if (event.key === ' ') {  // sustain pedal\n      sustaining = false;\n\n      // Release everything.\n      sustainingNotes.forEach((note) => player.playNoteUp(note, -1));\n      sustainingNotes = [];\n    } else {\n      const button = getButtonFromKeyCode(event.code);\n      if (button != null) {\n        buttonUp(button);\n      }\n    }\n  }\n\n  function onWindowResize() {\n    OCTAVES = window.innerWidth > 700 ? 7 : 3;\n    const bonusNotes = OCTAVES > 6 ? 4 : 0;  // starts on an A, ends on a C.\n    const totalNotes = CONSTANTS.NOTES_PER_OCTAVE * OCTAVES + bonusNotes;\n    const totalWhiteNotes = CONSTANTS.WHITE_NOTES_PER_OCTAVE * OCTAVES + (bonusNotes - 1);\n    keyWhitelist = Array(totalNotes).fill().map((x,i) => {\n      if (OCTAVES > 6) return i;\n      // Starting 3 semitones up on small screens (on a C), and a whole octave up.\n      return i + 3 + CONSTANTS.NOTES_PER_OCTAVE;\n    });\n\n    piano.resize(totalWhiteNotes);\n    painter.resize(piano.config.whiteNoteHeight);\n    piano.draw();\n  }\n\n  /*************************\n   * Utils and helpers\n   ************************/\n  function getButtonFromKeyCode(code) {\n    let index;\n    if (isUsingMakey) {\n      index = KEYCODES_MAKEY.indexOf(code);\n    } else {\n      index = KEYCODES_NUMBERS.indexOf(code);\n      if (index === -1) {\n        index = KEYCODES_STD.indexOf(code);\n      }\n    }\n    return index !== -1 ? index : null;\n  }\n\n  function getTemperature() {\n    const hash = parseFloat(parseHashParameters()['temperature']) || 0.25;\n    const newTemp = Math.min(1, hash);\n    console.log('🧞‍♀️ temperature = ', newTemp);\n    return newTemp;\n  }\n\n  function parseHashParameters() {\n    const hash = window.location.hash.substring(1);\n    const params = {}\n    hash.split('&').map(hk => {\n      let temp = hk.split('=');\n      params[temp[0]] = temp[1]\n    });\n    return params;\n  }\n\n  function updateButtonText() {\n    const btns = document.querySelectorAll('.controls button.color');\n    const display = IMAGINARY.i18n.t(isUsingMakey ? 'keysMakeyMakey' : 'keys').split(' ');\n    for (let i = 0; i < btns.length; i++) {\n      btns[i].innerHTML = isUsingMakey ?\n        `<span>${display[i]}</span>` :\n        `<span>${i + 1}</span><br><span>${display[i]}</span>`;\n    }\n  }\n\n  document.querySelector('#btnInfo').addEventListener('click', () => {\n    const infoBox = document.querySelector('#infoBox');\n    infoBox.hidden = !infoBox.hidden;\n  });\n\n  document.querySelector('#btnSettings').addEventListener('click', () => {\n    const settingsBox = document.querySelector('#settingsBox');\n    settingsBox.hidden = !settingsBox.hidden;\n  });\n\n  const body = document.querySelector('body');\n  if (!body.requestFullscreen) {\n    document.querySelector('#btnFullscreen').style.display = 'none';\n  } else {\n    document.querySelector('#btnFullscreen').addEventListener('click', () => {\n      if (!document.fullscreenElement) {\n        body.requestFullscreen().catch((err) => {\n          alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);\n        });\n      } else {\n        document.exitFullscreen();\n      }\n    });\n  }\n};\n\n"]}