{"version":3,"sources":["node_modules/browser-pack/_prelude.js","js/main.js","js/piano-genie.js"],"names":["r","e","n","t","o","i","f","c","require","u","a","Error","code","p","exports","call","length","1","module","_pianoGenie","_main","defaultConfig","defaultLanguage","loadConfig","_callee2","uri","response","regeneratorRuntime","wrap","_context2","prev","next","fetch","sent","status","json","abrupt","t0","concat","message","statusText","stop","_asyncToGenerator","mark","_callee","config","_context","Object","t1","t2","t3","assign","IMAGINARY","i18n","init","queryStringVariable","translationsDirectory","initPianoGenie","t4","console","error","apply","this","arguments","keyWhitelist","CONSTANTS","COLORS","NUM_BUTTONS","NOTES_PER_OCTAVE","WHITE_NOTES_PER_OCTAVE","LOWEST_PIANO_KEY_MIDI_NOTE","NUM_NOTES","GENIE_CHECKPOINT","Player","_classCallCheck","player","mm","SoundFontPlayer","midiOut","midiIn","usingMidiOut","usingMidiIn","selectOutElement","document","getElementById","selectInElement","loadAllSamples","_createClass","key","value","seq","notes","push","pitch","loadSamples","button","sendMidiNoteOn","tone","context","resume","playNoteDown","sendMidiNoteOff","playNoteUp","midi","_this","addEventListener","event","initDevices","target","_this2","outputs","values","output","done","inputs","input","onmidimessage","msg","getMIDIMessage","innerHTML","map","device","name","join","selectedIndex","send","command","data","buttonDown","buttonUp","FloatyNotes","canvas","getContext","lineWidth","lineCap","contextHeight","whiteNoteHeight","width","window","innerWidth","height","innerHeight","x","noteToPaint","parseFloat","y","color","on","_this3","clearRect","filter","note","globalAlpha","fillStyle","fillRect","requestAnimationFrame","drawLoop","Piano","whiteNoteWidth","blackNoteWidth","blackNoteHeight","svg","svgNS","totalWhiteNotes","ratio","OCTAVES","Math","floor","setAttribute","halfABlackNote","index","blackNoteIndexes","makeRect","indexOf","_o","_i","rect","querySelector","log","removeAttribute","w","h","fill","stroke","createElementNS","appendChild","MAPPING_8","0","2","3","4","5","6","7","MAPPING_4","KEYCODES_NUMBERS","KEYCODES_STD","KEYCODES_MAKEY","BUTTON_MAPPING","TEMPERATURE","getTemperature","heldButtonToVisualData","Map","sustaining","sustainingNotes","mouseDownButton","genie","PianoGenie","painter","piano","isUsingMakey","updateNumButtons","num","buttons","querySelectorAll","hidden","doTouchStart","preventDefault","dataset","id","doTouchEnd","doTouchMove","down","el","has","nextFromKeyWhitelist","highlightNote","addNote","getAttribute","set","thing","get","clearNote","stopNote","onKeyDown","repeat","resetState","getButtonFromKeyCode","onKeyUp","forEach","onWindowResize","bonusNotes","totalNotes","Array","resize","draw","hash","params","location","substring","split","hk","temp","newTemp","min","updateButtonText","btns","display","initialize","then","playBtn","textContent","classList","remove","checked","controls","passive","radioMidiOutYes","midiOutBox","radioAudioYes","radioMidiInYes","midiInBox","radioDeviceYes","radioMakeyYes","navigator","requestMIDIAccess","midiNotSupported","parentElement","midiReady","err","settingsBox","body","requestFullscreen","fullscreenElement","exitFullscreen","alert","style"],"mappings":"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","file":"bundle.min.js","sourcesContent":["(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c=\"function\"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error(\"Cannot find module '\"+i+\"'\");throw a.code=\"MODULE_NOT_FOUND\",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u=\"function\"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()","/* globals IMAGINARY */\nimport { initPianoGenie } from './piano-genie';\n\nconst defaultConfig = {\n  defaultLanguage: 'en',\n};\n\n/**\n * Loads the config file from an external JSON file\n *\n * @param {String} uri\n * @return {Promise<any>}\n */\nasync function loadConfig(uri) {\n  const response = await fetch(uri);\n  if (response.status >= 200 && response.status < 300) {\n    try {\n      return await response.json();\n    } catch (e) {\n      throw new Error(`Error parsing config file: ${e.message}`);\n    }\n  }\n  throw new Error(`Server returned status ${response.status} (${response.statusText}) loading config file.`);\n}\n\n/**\n * Load config files and start the program\n */\n(async function main() {\n  try {\n    const config = Object.assign({}, defaultConfig, await loadConfig('./config.json'));\n    await IMAGINARY.i18n.init({\n      queryStringVariable: 'lang',\n      translationsDirectory: 'tr',\n      defaultLanguage: config.defaultLanguage || 'en',\n    });\n    initPianoGenie();\n  } catch (err) {\n    // eslint-disable-next-line no-console\n    console.error(err);\n  }\n}());\n","/* globals IMAGINARY */\n\nexport function initPianoGenie() {\n\n  const CONSTANTS = {\n    COLORS : ['#db4c67','#ff8459','#ffec02','#73ff6c',\n      '#00c5ba','#3753be','#9c52ff','#ef71f2'],\n    NUM_BUTTONS : 8,\n    NOTES_PER_OCTAVE : 12,\n    WHITE_NOTES_PER_OCTAVE : 7,\n    LOWEST_PIANO_KEY_MIDI_NOTE : 21,\n    NUM_NOTES: 88,\n    GENIE_CHECKPOINT : 'model/genie',\n  }\n\n  /*************************\n   * MIDI or Magenta player\n   ************************/\n  class Player {\n    constructor() {\n      this.player = new mm.SoundFontPlayer('vendor/sgm_plus');\n      this.midiOut = [];\n      this.midiIn = []\n      this.usingMidiOut = false;\n      this.usingMidiIn = false;\n      this.selectOutElement = document.getElementById('selectOut');\n      this.selectInElement = document.getElementById('selectIn');\n      this.loadAllSamples();\n    }\n\n    loadAllSamples() {\n      const seq = {notes:[]};\n      for (let i = 0; i < CONSTANTS.NUM_NOTES; i++) {\n        seq.notes.push({pitch: CONSTANTS.LOWEST_PIANO_KEY_MIDI_NOTE + i});\n      }\n      this.player.loadSamples(seq);\n    }\n\n    playNoteDown(pitch, button) {\n      // Send to MIDI out or play with the Magenta player.\n      if (this.usingMidiOut) {\n        this.sendMidiNoteOn(pitch, button);\n      } else {\n        mm.Player.tone.context.resume();\n        this.player.playNoteDown({pitch:pitch});\n      }\n    }\n\n    playNoteUp(pitch, button) {\n      // Send to MIDI out or play with the Magenta player.\n      if (this.usingMidiOut) {\n        this.sendMidiNoteOff(pitch, button);\n      } else {\n        this.player.playNoteUp({pitch:pitch});\n      }\n    }\n\n    // MIDI bits.\n    midiReady(midi) {\n      // Also react to device changes.\n      midi.addEventListener('statechange', (event) => this.initDevices(event.target));\n      this.initDevices(midi);\n    }\n\n    initDevices(midi) {\n      this.midiOut = [];\n      this.midiIn = [];\n\n\n      const outputs = midi.outputs.values();\n      for (let output = outputs.next(); output && !output.done; output = outputs.next()) {\n        this.midiOut.push(output.value);\n      }\n\n      const inputs = midi.inputs.values();\n      for (let input = inputs.next(); input && !input.done; input = inputs.next()) {\n        this.midiIn.push(input.value);\n        // TODO: should probably use the selected index from this.selectInElement for correctness\n        // but i'm hacking this together for a demo so...\n        input.value.onmidimessage = (msg) => this.getMIDIMessage(msg);\n\n      }\n\n      // No MIDI, no settings.\n      //btnSettings.hidden = (this.midiOut.length === 0 && this.midiIn.length === 0);\n      this.selectInElement.innerHTML = this.midiIn.map(device => `<option>${device.name}</option>`).join('');\n      this.selectOutElement.innerHTML = this.midiOut.map(device => `<option>${device.name}</option>`).join('');\n    }\n\n    sendMidiNoteOn(pitch, button) {\n      // -1 is sent when releasing the sustain pedal.\n      if (button === -1) button = 0;\n      //const msg = [0x90 + button, pitch, 0x7f];    // note on, full velocity.\n      const msg = [0x90, pitch, 0x7f];    // note on, full velocity.\n      this.midiOut[this.selectOutElement.selectedIndex].send(msg);\n    }\n\n    sendMidiNoteOff(pitch, button) {\n      // -1 is sent when releasing the sustain pedal.\n      if (button === -1) button = 0;\n      //const msg = [0x80 + button, pitch, 0x7f];    // note on, middle C, full velocity.\n      const msg = [0x80, pitch, 0x7f];    // note on, middle C, full velocity.\n      this.midiOut[this.selectOutElement.selectedIndex].send(msg);\n    }\n\n    getMIDIMessage(msg) {\n      if (!this.usingMidiIn) {\n        return;\n      }\n      const command = msg.data[0];\n      const button = msg.data[1];\n      const velocity = (msg.data.length > 2) ? msg.data[2] : 0; // a velocity value might not be included with a noteOff command\n\n      switch (command) {\n        case 0x90: // note on\n          buttonDown(button, false);\n          break;\n        case 0x80: // note off\n          buttonUp(button);\n          break;\n      }\n    }\n  }\n\n  /*************************\n   * Floaty notes\n   ************************/\n  class FloatyNotes {\n    constructor() {\n      this.notes = [];  // the notes floating on the screen.\n\n      this.canvas = document.getElementById('canvas')\n      this.context = this.canvas.getContext('2d');\n      this.context.lineWidth = 4;\n      this.context.lineCap = 'round';\n\n      this.contextHeight = 0;\n    }\n\n    resize(whiteNoteHeight) {\n      this.canvas.width = window.innerWidth;\n      this.canvas.height = this.contextHeight = window.innerHeight - whiteNoteHeight - 20;\n    }\n\n    addNote(button, x, width) {\n      const noteToPaint = {\n        x: parseFloat(x),\n        y: 0,\n        width: parseFloat(width),\n        height: 0,\n        color: CONSTANTS.COLORS[button],\n        on: true\n      };\n      this.notes.push(noteToPaint);\n      return noteToPaint;\n    }\n\n    stopNote(noteToPaint) {\n      noteToPaint.on = false;\n    }\n\n    drawLoop() {\n      const dy = 3;\n      this.context.clearRect(0, 0, window.innerWidth, window.innerHeight);\n\n      // Remove all the notes that will be off the page;\n      this.notes = this.notes.filter((note) => note.on || note.y < (this.contextHeight - 100));\n\n      // Advance all the notes.\n      for (let i = 0; i < this.notes.length; i++) {\n        const note = this.notes[i];\n\n        // If the note is still on, then its height goes up but it\n        // doesn't start sliding down yet.\n        if (note.on) {\n          note.height += dy;\n        } else {\n          note.y += dy;\n        }\n\n        this.context.globalAlpha = 1 - note.y / this.contextHeight;\n        this.context.fillStyle = note.color;\n        this.context.fillRect(note.x, note.y, note.width, note.height);\n      }\n      window.requestAnimationFrame(() => this.drawLoop());\n    }\n  }\n\n  class Piano {\n    constructor() {\n      this.config = {\n        whiteNoteWidth: 20,\n        blackNoteWidth: 20,\n        whiteNoteHeight: 70,\n        blackNoteHeight: 2 * 70 / 3\n      }\n\n      this.svg = document.getElementById('svg');\n      this.svgNS = 'http://www.w3.org/2000/svg';\n    }\n\n    resize(totalWhiteNotes) {\n      // i honestly don't know why some flooring is good and some is bad sigh.\n      const ratio = window.innerWidth / totalWhiteNotes;\n      this.config.whiteNoteWidth = OCTAVES > 6 ? ratio: Math.floor(ratio);\n      this.config.blackNoteWidth = this.config.whiteNoteWidth * 2 / 3;\n      this.svg.setAttribute('width', window.innerWidth);\n      this.svg.setAttribute('height', this.config.whiteNoteHeight);\n    }\n\n    draw() {\n      this.svg.innerHTML = '';\n      const halfABlackNote = this.config.blackNoteWidth / 2;\n      let x = 0;\n      let y = 0;\n      let index = 0;\n\n      const blackNoteIndexes = [1, 3, 6, 8, 10];\n\n      // First draw all the white notes.\n      // Pianos start on an A (if we're using all the octaves);\n      if (OCTAVES > 6) {\n        this.makeRect(0, x, y, this.config.whiteNoteWidth, this.config.whiteNoteHeight, 'white', '#141E30');\n        this.makeRect(2, this.config.whiteNoteWidth, y, this.config.whiteNoteWidth, this.config.whiteNoteHeight, 'white', '#141E30');\n        index = 3;\n        x = 2 * this.config.whiteNoteWidth;\n      } else {\n        // Starting 3 semitones up on small screens (on a C), and a whole octave up.\n        index = 3 + CONSTANTS.NOTES_PER_OCTAVE;\n      }\n\n      // Draw the white notes.\n      for (let o = 0; o < OCTAVES; o++) {\n        for (let i = 0; i < CONSTANTS.NOTES_PER_OCTAVE; i++) {\n          if (blackNoteIndexes.indexOf(i) === -1) {\n            this.makeRect(index, x, y, this.config.whiteNoteWidth, this.config.whiteNoteHeight, 'white', '#141E30');\n            x += this.config.whiteNoteWidth;\n          }\n          index++;\n        }\n      }\n\n      if (OCTAVES > 6) {\n        // And an extra C at the end (if we're using all the octaves);\n        this.makeRect(index, x, y, this.config.whiteNoteWidth, this.config.whiteNoteHeight, 'white', '#141E30');\n\n        // Now draw all the black notes, so that they sit on top.\n        // Pianos start on an A:\n        this.makeRect(1, this.config.whiteNoteWidth - halfABlackNote, y, this.config.blackNoteWidth, this.config.blackNoteHeight, 'black');\n        index = 3;\n        x = this.config.whiteNoteWidth;\n      } else {\n        // Starting 3 semitones up on small screens (on a C), and a whole octave up.\n        index = 3 + CONSTANTS.NOTES_PER_OCTAVE;\n        x = -this.config.whiteNoteWidth;\n      }\n\n      // Draw the black notes.\n      for (let o = 0; o < OCTAVES; o++) {\n        for (let i = 0; i < CONSTANTS.NOTES_PER_OCTAVE; i++) {\n          if (blackNoteIndexes.indexOf(i) !== -1) {\n            this.makeRect(index, x + this.config.whiteNoteWidth - halfABlackNote, y, this.config.blackNoteWidth, this.config.blackNoteHeight, 'black');\n          } else {\n            x += this.config.whiteNoteWidth;\n          }\n          index++;\n        }\n      }\n    }\n\n    highlightNote(note, button) {\n      // Show the note on the piano roll.\n      const rect = this.svg.querySelector(`rect[data-index=\"${note}\"]`);\n      if (!rect) {\n        console.log('couldnt find a rect for note', note);\n        return;\n      }\n      rect.setAttribute('active', true);\n      rect.setAttribute('class', `color-${button}`);\n      return rect;\n    }\n\n    clearNote(rect) {\n      rect.removeAttribute('active');\n      rect.removeAttribute('class');\n    }\n\n    makeRect(index, x, y, w, h, fill, stroke) {\n      const rect = document.createElementNS(this.svgNS, 'rect');\n      rect.setAttribute('data-index', index);\n      rect.setAttribute('x', x);\n      rect.setAttribute('y', y);\n      rect.setAttribute('width', w);\n      rect.setAttribute('height', h);\n      rect.setAttribute('fill', fill);\n      if (stroke) {\n        rect.setAttribute('stroke', stroke);\n        rect.setAttribute('stroke-width', '3px');\n      }\n      this.svg.appendChild(rect);\n      return rect;\n    }\n  }\n\n  /*************************\n   * Consts for everyone!\n   ************************/\n// button mappings.\n  const MAPPING_8 = {0:0, 1:1, 2:2, 3:3, 4:4, 5:5, 6:6, 7:7};\n  const MAPPING_4 = {0:0, 1:2, 2:5, 3:7, 4:0, 5:2, 6:5, 7:7};\n  const KEYCODES_NUMBERS = ['Digit1', 'Digit2', 'Digit3', 'Digit4', 'Digit5', 'Digit6', 'Digit7', 'Digit8'];\n  const KEYCODES_STD = ['KeyA', 'KeyS', 'KeyD', 'KeyF', 'KeyJ', 'KeyK', 'KeyL', 'Semicolon'];\n  const KEYCODES_MAKEY = ['ArrowUp','ArrowLeft','ArrowDown','ArrowRight', 'KeyW', 'KeyA', 'KeyS', 'KeyD'];\n\n  let OCTAVES = 7;\n  let NUM_BUTTONS = 8;\n  let BUTTON_MAPPING = MAPPING_8;\n\n  let keyWhitelist;\n  let TEMPERATURE = getTemperature();\n\n  const heldButtonToVisualData = new Map();\n\n// Which notes the pedal is sustaining.\n  let sustaining = false\n  let sustainingNotes = [];\n\n// Mousedown/up events are weird because you can mouse down in one element and mouse up\n// in another, so you're going to lose that original element and never mouse it up.\n  let mouseDownButton = null;\n\n  const player = new Player();\n  const genie = new mm.PianoGenie(CONSTANTS.GENIE_CHECKPOINT);\n  const painter = new FloatyNotes();\n  const piano = new Piano();\n  let isUsingMakey = false;\n  initEverything();\n\n  /*************************\n   * Basic UI bits\n   ************************/\n  function initEverything() {\n    genie.initialize().then(() => {\n      console.log('🧞‍♀️ ready!');\n      playBtn.textContent = 'Play';\n      playBtn.removeAttribute('disabled');\n      playBtn.classList.remove('loading');\n    });\n\n    // Start the drawing loop.\n    onWindowResize();\n    updateButtonText();\n    window.requestAnimationFrame(() => painter.drawLoop());\n\n    // Event listeners.\n    document.getElementById('numButtons4').addEventListener('change', (event) => event.target.checked && updateNumButtons(4));\n    document.getElementById('numButtons8').addEventListener('change', (event) => event.target.checked && updateNumButtons(8));\n\n    window.addEventListener('resize', onWindowResize);\n    window.addEventListener('orientationchange', onWindowResize);\n    window.addEventListener('hashchange', () => TEMPERATURE = getTemperature());\n  }\n\n  function updateNumButtons(num) {\n    NUM_BUTTONS = num;\n    const buttons = document.querySelectorAll('.controls > .keyboard > button.color');\n    BUTTON_MAPPING = (num === 4) ? MAPPING_4 : MAPPING_8;\n\n    // Hide the extra buttons.\n    for (let i = 0; i < buttons.length; i++) {\n      buttons[i].hidden = i >= num;\n    }\n  }\n\n  function showMainScreen() {\n    document.querySelector('.splash').hidden = true;\n    document.querySelector('.loaded').hidden = false;\n\n    document.addEventListener('keydown',onKeyDown);\n\n    controls.addEventListener('touchstart', (event) => doTouchStart(event), {passive: true});\n    controls.addEventListener('touchend', (event) => doTouchEnd(event), {passive: true});\n\n    const hasTouchEvents = ('ontouchstart' in window);\n    if (!hasTouchEvents) {\n      controls.addEventListener('mousedown', (event) => doTouchStart(event));\n      controls.addEventListener('mouseup', (event) => doTouchEnd(event));\n    }\n\n    controls.addEventListener('mouseover', (event) => doTouchMove(event, true));\n    controls.addEventListener('mouseout', (event) => doTouchMove(event, false));\n    controls.addEventListener('touchenter', (event) => doTouchMove(event, true));\n    controls.addEventListener('touchleave', (event) => doTouchMove(event, false));\n    canvas.addEventListener('mouseenter', () => mouseDownButton = null);\n\n    // Output.\n    radioMidiOutYes.addEventListener('click', () => {\n      player.usingMidiOut = true;\n      midiOutBox.hidden = false;\n    });\n    radioAudioYes.addEventListener('click', () => {\n      player.usingMidiOut = false;\n      midiOutBox.hidden = true;\n    });\n    // Input.\n    radioMidiInYes.addEventListener('click', () => {\n      player.usingMidiIn = true;\n      midiInBox.hidden = false;\n      isUsingMakey = false;\n      updateButtonText();\n    });\n    radioDeviceYes.addEventListener('click', () => {\n      player.usingMidiIn = false;\n      midiInBox.hidden = true;\n      isUsingMakey = false;\n      updateButtonText();\n    });\n    radioMakeyYes.addEventListener('click', () => {\n      player.usingMidiIn = false;\n      midiInBox.hidden = true;\n      isUsingMakey = true;\n      updateButtonText();\n    });\n\n    // Figure out if WebMidi works.\n    if (navigator.requestMIDIAccess) {\n      midiNotSupported.hidden = true;\n      radioMidiInYes.parentElement.removeAttribute('disabled');\n      radioMidiOutYes.parentElement.removeAttribute('disabled');\n      navigator.requestMIDIAccess()\n        .then(\n          (midi) => player.midiReady(midi),\n          (err) => console.log('Something went wrong', err));\n    } else {\n      midiNotSupported.hidden = false;\n      radioMidiInYes.parentElement.setAttribute('disabled', true);\n      radioMidiOutYes.parentElement.setAttribute('disabled', true);\n    }\n\n    document.addEventListener('keyup', onKeyUp);\n\n    // Slow to start up, so do a fake prediction to warm up the model.\n    const note = genie.nextFromKeyWhitelist(0, keyWhitelist, TEMPERATURE);\n    genie.resetState();\n  }\n\n// Here touch means either touch or mouse.\n  function doTouchStart(event) {\n    event.preventDefault();\n    mouseDownButton = event.target;\n    buttonDown(event.target.dataset.id, true);\n  }\n  function doTouchEnd(event) {\n    event.preventDefault();\n    if (mouseDownButton && mouseDownButton !== event.target) {\n      buttonUp(mouseDownButton.dataset.id);\n    }\n    mouseDownButton = null;\n    buttonUp(event.target.dataset.id);\n  }\n  function doTouchMove(event, down) {\n    // If we're already holding a button down, start holding this one too.\n    if (!mouseDownButton)\n      return;\n\n    if (down)\n      buttonDown(event.target.dataset.id, true);\n    else\n      buttonUp(event.target.dataset.id, true);\n  }\n\n  /*************************\n   * Button actions\n   ************************/\n  function buttonDown(button, fromKeyDown) {\n    // If we're already holding this button down, nothing new to do.\n    if (heldButtonToVisualData.has(button)) {\n      return;\n    }\n\n    const el = document.getElementById(`btn${button}`);\n    if (!el)\n      return;\n    el.setAttribute('active', true);\n\n    const note = genie.nextFromKeyWhitelist(BUTTON_MAPPING[button], keyWhitelist, TEMPERATURE);\n    const pitch = CONSTANTS.LOWEST_PIANO_KEY_MIDI_NOTE + note;\n\n    // Hear it.\n    player.playNoteDown(pitch, button);\n\n    // See it.\n    const rect = piano.highlightNote(note, button);\n\n    if (!rect) {\n      debugger;\n    }\n    // Float it.\n    const noteToPaint = painter.addNote(button, rect.getAttribute('x'), rect.getAttribute('width'));\n    heldButtonToVisualData.set(button, {rect:rect, note:note, noteToPaint:noteToPaint});\n  }\n\n  function buttonUp(button) {\n    const el = document.getElementById(`btn${button}`);\n    if (!el)\n      return;\n    el.removeAttribute('active');\n\n    const thing = heldButtonToVisualData.get(button);\n    if (thing) {\n      // Don't see it.\n      piano.clearNote(thing.rect);\n\n      // Stop holding it down.\n      painter.stopNote(thing.noteToPaint);\n\n      // Maybe stop hearing it.\n      const pitch = CONSTANTS.LOWEST_PIANO_KEY_MIDI_NOTE + thing.note;\n      if (!sustaining) {\n        player.playNoteUp(pitch, button);\n      } else {\n        sustainingNotes.push(CONSTANTS.LOWEST_PIANO_KEY_MIDI_NOTE + thing.note);\n      }\n    }\n    heldButtonToVisualData.delete(button);\n  }\n\n  /*************************\n   * Events\n   ************************/\n  function onKeyDown(event) {\n    // Keydown fires continuously and we don't want that.\n    if (event.repeat) {\n      return;\n    }\n    if (event.key === ' ') {  // sustain pedal\n      sustaining = true;\n    } else if (event.key === '0' || event.key === 'r') {\n      console.log('🧞‍♀️ resetting!');\n      genie.resetState();\n    } else {\n      const button = getButtonFromKeyCode(event.code);\n      if (button != null) {\n        buttonDown(button, true);\n      }\n    }\n  }\n\n  function onKeyUp(event) {\n    if (event.key === ' ') {  // sustain pedal\n      sustaining = false;\n\n      // Release everything.\n      sustainingNotes.forEach((note) => player.playNoteUp(note, -1));\n      sustainingNotes = [];\n    } else {\n      const button = getButtonFromKeyCode(event.code);\n      if (button != null) {\n        buttonUp(button);\n      }\n    }\n  }\n\n  function onWindowResize() {\n    OCTAVES = window.innerWidth > 700 ? 7 : 3;\n    const bonusNotes = OCTAVES > 6 ? 4 : 0;  // starts on an A, ends on a C.\n    const totalNotes = CONSTANTS.NOTES_PER_OCTAVE * OCTAVES + bonusNotes;\n    const totalWhiteNotes = CONSTANTS.WHITE_NOTES_PER_OCTAVE * OCTAVES + (bonusNotes - 1);\n    keyWhitelist = Array(totalNotes).fill().map((x,i) => {\n      if (OCTAVES > 6) return i;\n      // Starting 3 semitones up on small screens (on a C), and a whole octave up.\n      return i + 3 + CONSTANTS.NOTES_PER_OCTAVE;\n    });\n\n    piano.resize(totalWhiteNotes);\n    painter.resize(piano.config.whiteNoteHeight);\n    piano.draw();\n  }\n\n  /*************************\n   * Utils and helpers\n   ************************/\n  function getButtonFromKeyCode(code) {\n    let index;\n    if (isUsingMakey) {\n      index = KEYCODES_MAKEY.indexOf(code);\n    } else {\n      index = KEYCODES_NUMBERS.indexOf(code);\n      if (index === -1) {\n        index = KEYCODES_STD.indexOf(code);\n      }\n    }\n    return index !== -1 ? index : null;\n  }\n\n  function getTemperature() {\n    const hash = parseFloat(parseHashParameters()['temperature']) || 0.25;\n    const newTemp = Math.min(1, hash);\n    console.log('🧞‍♀️ temperature = ', newTemp);\n    return newTemp;\n  }\n\n  function parseHashParameters() {\n    const hash = window.location.hash.substring(1);\n    const params = {}\n    hash.split('&').map(hk => {\n      let temp = hk.split('=');\n      params[temp[0]] = temp[1]\n    });\n    return params;\n  }\n\n  function updateButtonText() {\n    const btns = document.querySelectorAll('.controls button.color');\n    const display = IMAGINARY.i18n.t(isUsingMakey ? 'keysMakeyMakey' : 'keys').split(' ');\n    for (let i = 0; i < btns.length; i++) {\n      btns[i].innerHTML = isUsingMakey ?\n        `<span>${display[i]}</span>` :\n        `<span>${i + 1}</span><br><span>${display[i]}</span>`;\n    }\n  }\n\n  document.querySelector('#playBtn').addEventListener('click', () => {\n    showMainScreen();\n  });\n\n  document.querySelector('#btnSettings').addEventListener('click', () => {\n    const settingsBox = document.querySelector('#settingsBox');\n    settingsBox.hidden = !settingsBox.hidden;\n  });\n\n  const body = document.querySelector('body');\n  if (!body.requestFullscreen) {\n    document.querySelector('#btnFullscreen').style.display = 'none';\n  } else {\n    document.querySelector('#btnFullscreen').addEventListener('click', () => {\n      if (!document.fullscreenElement) {\n        body.requestFullscreen().catch((err) => {\n          alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);\n        });\n      } else {\n        document.exitFullscreen();\n      }\n    });\n  }\n};\n\n"]}